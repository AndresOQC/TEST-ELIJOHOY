import{m as j,D as L,p as H,G as X,t as y,x as z,N as A,V as Z,r as h,O as K,a as S,o as r,w as I,X as W,h as a,ai as g,g as x,k,U as _,aj as C,ak as P,al as O,am as Y,f as q,an as ee,Q as B,i as se}from"./index-CsgqY5LX.js";import{Q as ae}from"./QPage-D1Uu3bMR.js";import{u as te}from"./test-BtNdyhCX.js";import{u as oe}from"./use-quasar-DFu13bAx.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./test-BC_opDEd.js";const re=j({name:"QBanner",props:{...L,inlineActions:Boolean,dense:Boolean,rounded:Boolean},setup(m,{slots:p}){const{proxy:{$q:t}}=H(),d=X(m,t),f=y(()=>"q-banner row items-center"+(m.dense===!0?" q-banner--dense":"")+(d.value===!0?" q-banner--dark q-dark":"")+(m.rounded===!0?" rounded-borders":"")),i=y(()=>`q-banner__actions row items-center justify-end col-${m.inlineActions===!0?"auto":"all"}`);return()=>{const v=[z("div",{class:"q-banner__avatar col-auto row items-center self-start"},A(p.avatar)),z("div",{class:"q-banner__content col text-body2"},A(p.default))],l=A(p.action);return l!==void 0&&v.push(z("div",{class:i.value},l)),z("div",{class:f.value+(m.inlineActions===!1&&l!==void 0?" q-banner--top-padding":""),role:"alert"},v)}}}),ie={class:"container"},le={class:"test-header"},ce={class:"progress-info"},ue={class:"progress-text"},de={class:"progress-dots"},ge={key:0,class:"questions-container"},pe={class:"question-number"},ve={class:"question-options"},fe={class:"option-label left"},me={class:"bubbles-selector"},he=["onClick"],_e={class:"option-label right"},ye={key:1,class:"loading-container"},be={class:"navigation-buttons"},we={key:1},ze={key:2,class:"error-notification"},N=3,Se={__name:"TestPage",setup(m){const p=W(),t=te(),d=Z(),f=oe(),i=h(!1),v=h([]),l=h({}),c=h(0),R=h(!1),b=h(""),Q=[64,48,32,48,64],w=y(()=>Math.ceil(v.value.length/N)),E=y(()=>{const e=c.value*N,s=e+N;return v.value.slice(e,s)}),F=y(()=>E.value.every(e=>l.value[e.id_pregunta])),T=y(()=>v.value.every(e=>l.value[e.id_pregunta]));async function D(){if(console.log("Iniciando finalizaci√≥n autom√°tica del test..."),!T.value)throw new Error("El test no est√° completo");i.value=!0;try{if(d.isAuthenticated){if(!t.getSesion){if(console.log("Creando sesi√≥n y sincronizando respuestas..."),!(await t.iniciarTest()).success)throw new Error("Error al crear sesi√≥n de test");const o=localStorage.getItem("testRespuestas");if(o){const n=JSON.parse(o);if((await t.sincronizarRespuestas(n)).success)console.log("Respuestas sincronizadas exitosamente"),localStorage.removeItem("testRespuestas");else throw new Error("Error al sincronizar respuestas")}}const e=await t.finalizarTest();if(e.success)console.log("Test finalizado exitosamente"),f.notify({type:"positive",message:"¬°Test completado! Tus resultados han sido guardados.",icon:"check_circle"}),p.push({name:"test-resultados",params:{id:t.getSesion.id_sesion}});else throw new Error(e.message||"Error al finalizar el test")}else throw new Error("Usuario no autenticado")}catch(e){throw console.error("Error en finalizaci√≥n autom√°tica:",e),e}finally{i.value=!1}}function G(e){return l.value[e]||null}function M(e,s){l.value[e]=s,localStorage.setItem("testRespuestas",JSON.stringify(l.value)),console.log("Respuesta guardada en localStorage:",e,s)}function V(){F.value&&c.value<w.value-1&&(c.value++,window.scrollTo({top:0,behavior:"smooth"}))}function J(){c.value>0&&(c.value--,window.scrollTo({top:0,behavior:"smooth"}))}async function $(){if(!T.value){R.value=!0,b.value="Debes responder todas las preguntas antes de finalizar el test.";return}try{if(i.value=!0,!d.isAuthenticated){i.value=!1,f.dialog({title:"Iniciar Sesi√≥n Requerido",message:"Para guardar tus resultados y acceder a ellos en el futuro, debes iniciar sesi√≥n o crear una cuenta.",persistent:!0,ok:{label:"Iniciar Sesi√≥n",color:"primary",noCaps:!0},cancel:{label:"Crear Cuenta",color:"secondary",noCaps:!0,flat:!0}}).onOk(()=>{localStorage.setItem("pendingTestFinalization","true"),p.push("/auth/login")}).onCancel(()=>{localStorage.setItem("pendingTestFinalization","true"),p.push("/auth/registro")});return}if(d.isAuthenticated){if(!t.getSesion){console.log("Creando sesi√≥n y sincronizando respuestas antes de finalizar...");try{if(!(await t.iniciarTest()).success)throw new Error("Error al crear sesi√≥n de test");const o=localStorage.getItem("testRespuestas");if(o){const n=JSON.parse(o);if((await t.sincronizarRespuestas(n)).success)console.log("Respuestas sincronizadas exitosamente"),localStorage.removeItem("testRespuestas");else throw new Error("Error al sincronizar respuestas")}}catch(s){console.error("Error en sincronizaci√≥n:",s),R.value=!0,b.value="Error al guardar el test. Intenta nuevamente.";return}}const e=await t.finalizarTest();if(e.success)f.notify({type:"positive",message:"Test completado exitosamente"}),p.push({name:"test-resultados",params:{id:t.getSesion.id_sesion}});else throw new Error(e.message||"Error al finalizar el test")}}catch(e){if(e.message==="REQUIERE_AUTH")return;e.value=!0,b.value=e.message||"Error al finalizar el test."}finally{i.value=!1}}return K(async()=>{console.log("üöÄ TestPage onMounted - Iniciando carga del test"),d.initializeAuth(),console.log("üîê Estado de autenticaci√≥n:",d.isAuthenticated),console.log("üë§ Usuario:",d.user),console.log("üîë Token en sessionStorage:",sessionStorage.getItem("access_token")?"Presente":"Ausente");try{i.value=!0,console.log("üìö Cargando preguntas...");const e=await t.cargarPreguntas();if(console.log("Respuesta del API preguntas:",e),e.success&&(v.value=e.preguntas,console.log("Preguntas cargadas:",v.value.length)),d.isAuthenticated&&!t.getSesion){console.log("‚úÖ Usuario autenticado, verificando sesiones existentes...");try{const n=await t.cargarMisSesiones();if(console.log("Respuesta sesiones:",n),n.success&&n.sesiones.length>0){const u=n.sesiones.find(U=>!U.completado);u&&(console.log("Sesi√≥n activa encontrada:",u),t.sesionActual=u)}}catch(n){console.log("No hay sesiones existentes o error al cargar:",n.message)}}const s=localStorage.getItem("testRespuestas");if(s&&(l.value=JSON.parse(s),console.log("Respuestas restauradas de localStorage:",l.value)),localStorage.getItem("pendingTestFinalization")==="true"&&d.isAuthenticated&&s){console.log("Finalizaci√≥n de test pendiente detectada, procediendo autom√°ticamente..."),localStorage.removeItem("pendingTestFinalization");try{await D()}catch(n){console.error("Error en finalizaci√≥n autom√°tica:",n),f.notify({type:"negative",message:"Error al finalizar el test autom√°ticamente",icon:"error"})}}}catch(e){f.notify({type:"negative",message:e.message||"Error al cargar el test"})}finally{i.value=!1}}),(e,s)=>(r(),S(ae,{class:"test-page"},{default:I(()=>[a("div",ie,[a("div",le,[s[3]||(s[3]=a("h1",{class:"test-title"},"Test de Personalidad",-1)),a("div",ce,[a("div",ue,[s[0]||(s[0]=k(" Progreso: ",-1)),a("strong",null,_(c.value+1),1),s[1]||(s[1]=k(" de ",-1)),a("strong",null,_(w.value),1),s[2]||(s[2]=k(" p√°ginas ",-1))]),a("div",de,[(r(!0),g(C,null,P(w.value,o=>(r(),g("div",{key:o,class:O(["progress-dot",{active:o<=c.value+1,completed:o<c.value+1}])},null,2))),128))])])]),!i.value&&E.value.length>0?(r(),g("div",ge,[(r(!0),g(C,null,P(E.value,(o,n)=>(r(),g("div",{key:o.id_pregunta,class:"question-card"},[a("div",pe,"Pregunta "+_(c.value*3+n+1),1),a("div",ve,[a("div",fe,_(o.texto_izquierda),1),a("div",me,[(r(),g(C,null,P(5,u=>a("div",{key:u,class:O(["bubble",{selected:G(o.id_pregunta)===u}]),style:Y({width:Q[u-1]+"px",height:Q[u-1]+"px"}),onClick:U=>M(o.id_pregunta,u)},[...s[4]||(s[4]=[a("div",{class:"bubble-inner"},null,-1)])],14,he)),64))]),a("div",_e,_(o.texto_derecha),1)])]))),128))])):x("",!0),i.value?(r(),g("div",ye,[q(ee,{color:"purple-7",size:"60px"}),s[5]||(s[5]=a("p",null,"Cargando test...",-1))])):x("",!0),a("div",be,[c.value>0?(r(),S(B,{key:0,unelevated:"",color:"grey-6",label:"Anterior",icon:"arrow_back",onClick:J,class:"nav-btn","no-caps":""})):(r(),g("div",we)),c.value<w.value-1?(r(),S(B,{key:2,unelevated:"",color:"purple-7",label:"Siguiente","icon-right":"arrow_forward",onClick:V,disable:!F.value,class:"nav-btn","no-caps":""},null,8,["disable"])):(r(),S(B,{key:3,unelevated:"",color:"positive",label:"Finalizar Test","icon-right":"check_circle",onClick:$,disable:!T.value,class:"nav-btn finish-btn","no-caps":""},null,8,["disable"]))]),R.value?(r(),g("div",ze,[q(re,{class:"text-white bg-red-8",rounded:""},{avatar:I(()=>[q(se,{name:"error"})]),default:I(()=>[k(" "+_(b.value),1)]),_:1})])):x("",!0)])]),_:1}))}},xe=ne(Se,[["__scopeId","data-v-ebcaea17"]]);export{xe as default};
